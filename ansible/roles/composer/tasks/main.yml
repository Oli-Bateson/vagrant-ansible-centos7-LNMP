---
- name: Find PHP binary
  find:
    paths: /usr/bin/
    patterns: "{{ lookup('vars', 'phppattern') }}"
    use_regex: yes
    file_type: link
  register: php_binarys

- name: Install PHP Composer 2.1.14
  get_url:
    url: https://getcomposer.org/download/2.1.14/composer.phar
    dest: /usr/local/bin/composer
    mode: 0755
  when: php_version == "5.5" or php_version == "5.6" or php_version == "Zend5.6"

- name: Install PHP Composer 2.2.12 LTS
  get_url:
    url: https://getcomposer.org/download/2.2.12/composer.phar
    dest: /usr/local/bin/composer
    mode: 0755
  when: php_version == "7.2" or php_version == "7.3" or php_version == "7.4" or php_version == "8.1"

#- name: Install PHP Composer 2.3.5
#  get_url:
#    url: https://getcomposer.org/download/2.3.5/composer.phar
#    dest: /usr/local/bin/composer
#    mode: 0755

- name: Remove Global Phing
  become: true
  become_user: vagrant
  shell: "{{ item.path }} /usr/local/bin/composer global remove phing/phing"
  with_items: "{{ php_binarys.files }}"
  register: response
  changed_when: false
  failed_when: "response.stdout and not 'Could not read ./composer.json' in response.stderr"

- name: Install Global Phing
  become: true
  become_user: vagrant
  shell: "{{ item.path }} /usr/local/bin/composer global require phing/phing"
  with_items: "{{ php_binarys.files }}"
  changed_when: false
